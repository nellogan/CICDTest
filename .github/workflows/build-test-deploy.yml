name: build-test-deploy

permissions: write-all

env:
#  GITHUB_TOKEN: ${{ secrets.CICDTEST }}
  GITHUB_TOKEN: ${{ secrets.CICDWTF }}

on:
#  push:
#    branches:
#      - main

  pull_request:
    types:
      [ reopened ]
#    branches:
#      - main
  push:
    branches:
      - main


# todo preliminary-check
#      if: ${{ github.actor != github.repository_owner }} # todo trusted members instead of only owner.
# Verify that the feature branch does not change any workflow files unless author is a trusted member.
# HEAD^ is refers to the most recent commit in the repo while HEAD is the proposed new commit.
# Todo only supports owner update to check for trusted members instead.
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y gcc

      - name: Build functions.o
        run: gcc -I. -c functions.c -o functions.o

      - name: Build main.o
        run: gcc -I. -c main.c -o main.o

      - name: Build executable
        run: gcc -I. functions.o main.o -o main_exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: main_exe-artifact
          path: main_exe
          retention-days: 1

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: main_exe-artifact

      - name: Grant execution privilege and run test
        run: chmod 770 ./main_exe && ./main_exe

  deploy:
    needs: test
    runs-on: ubuntu-latest
#    permissions: write-all
#    if: ${{ github.actor == github.repository_owner }} # todo trusted members instead of only owner.
    permissions:
      contents: write # Needed to merge opened pull request
      pull-requests: write
    steps:
      - name: 'Auto approve pull request from trusted member'
        uses: actions/github-script@v6
        with:
          script: |
            console.log("github.actor:", github.actor);
            const { repo, owner } = context.repo;
            const pulls = await github.rest.pulls.list({
              owner: owner,
              repo: repo,
              head: context.ref,
              base: 'main',
              state: 'open',
            });
            console.log("\n\n pulls", pulls);
            const existing_pr = pulls.data[0];
            console.log("\n\n existing_pr", existing_pr);
            const mergePR = await github.rest.pulls.merge({
              owner: owner,
              repo: repo,
              pull_number: existing_pr.number,
              commit_title: 'commit title placeholder',
              commit_message: 'commit message placeholder',
              merge_method: "merge"
            });
            console.log("\n\n mergePR", mergePR);